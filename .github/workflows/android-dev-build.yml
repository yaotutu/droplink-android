name: Android Dev Build

on:
  # ç›‘å¬ dev åˆ†æ”¯çš„æŽ¨é€
  push:
    branches:
      - dev

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æŽˆäºˆ GitHub Actions åˆ›å»º Release çš„æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º/æ›´æ–° Release å’Œ Tag

jobs:
  build:
    name: æž„å»º Dev ç‰ˆæœ¬
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´çš„ Git åŽ†å²ï¼Œç”¨äºŽå‡†ç¡®è®¡ç®—æäº¤æ€»æ•°

      # è®¾ç½® JDK 17ï¼ˆå‚è€ƒ android-release.ymlï¼‰
      - name: Set up JDK
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      # éªŒè¯ Java çŽ¯å¢ƒ
      - name: Verify Java
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          java -version

      # æŽˆäºˆ gradlew æ‰§è¡Œæƒé™
      - name: Make gradlew executable
        run: chmod +x gradlew

      # è®¾ç½®ç‰ˆæœ¬å·ï¼ˆä»Ž version.properties è¯»å–ä¸»ç‰ˆæœ¬å· + è‡ªåŠ¨è®¡ç®—æ¬¡ç‰ˆæœ¬å·ï¼‰
      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version
        run: |
          # ä»Ž version.properties è¯»å–ä¸»ç‰ˆæœ¬å·ï¼ˆå¦‚ 0.1ï¼‰ï¼ŒæŽ’é™¤æ³¨é‡Šè¡Œï¼ŒåŽ»é™¤ç©ºæ ¼å’Œæ¢è¡Œç¬¦
          MAJOR_MINOR=$(grep "^MAJOR_MINOR=" version.properties | cut -d'=' -f2 | tr -d '[:space:]')

          # ä½¿ç”¨ dev åˆ†æ”¯çš„æ€»æäº¤æ•°ä½œä¸ºæ¬¡ç‰ˆæœ¬å·ï¼ˆç¡®ä¿ main å¯ä»¥ç»§æ‰¿ç›¸åŒçš„ç‰ˆæœ¬å·ï¼‰
          PATCH_COUNT=$(git rev-list --count HEAD)

          # Dev ç‰ˆæœ¬æ ¼å¼: 0.1.3-dev
          VERSION_NAME="${MAJOR_MINOR}.${PATCH_COUNT}-dev"
          VERSION_CODE=$(git rev-list --count HEAD)
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_ENV
          echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV
          echo "ðŸ“¦ Dev ç‰ˆæœ¬å·: ${VERSION_NAME} (versionCode: ${VERSION_CODE})"
          echo "ðŸ“Š ä¸»ç‰ˆæœ¬: ${MAJOR_MINOR}, æ¬¡ç‰ˆæœ¬: ${PATCH_COUNT}"
          echo "ðŸ• æž„å»ºæ—¶é—´: ${BUILD_TIME}"

      # è¿è¡Œå•å…ƒæµ‹è¯•
      - name: Run tests
        run: ./gradlew test

      # æž„å»º Debug APK
      - name: Build debug APK
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          VERSION_NAME: ${{ env.VERSION_NAME }}
          VERSION_CODE: ${{ env.VERSION_CODE }}
        run: |
          echo "Using JAVA_HOME=$JAVA_HOME"
          ./gradlew assembleDebug --stacktrace

      # é‡å‘½å APK æ–‡ä»¶
      - name: Rename APK
        run: |
          mkdir -p output
          # åˆ›å»ºå›ºå®šæ–‡ä»¶åçš„ APKï¼ˆç”¨äºŽæ°¸ä¹…ä¸‹è½½é“¾æŽ¥ï¼‰
          cp app/build/outputs/apk/debug/app-debug.apk output/droplink-dev.apk
          echo "âœ… APK å·²é‡å‘½åä¸º: droplink-dev.apk"

      # ä¸Šä¼  APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: droplink-dev-${{ env.VERSION_NAME }}
          path: output/droplink-dev.apk
          retention-days: 30

      # è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Release (è¦†ç›–å¼å‘å¸ƒ dev-latest)
      # æ³¨æ„ï¼šsoftprops/action-gh-release ä¼šè‡ªåŠ¨è¦†ç›–å·²å­˜åœ¨çš„ Releaseï¼Œæ— éœ€æ‰‹åŠ¨åˆ é™¤ tag
      - name: Create or Update Dev Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dev-latest
          name: "ðŸš€ Dev å¼€å‘ç‰ˆ (æœ€æ–°)"
          target_commitish: ${{ github.sha }}  # å¼ºåˆ¶ tag æŒ‡å‘å½“å‰æäº¤
          body: |
            ## ðŸ“¦ Droplink Dev å¼€å‘ç‰ˆ - è‡ªåŠ¨æž„å»º

            **ç‰ˆæœ¬å·**: `${{ env.VERSION_NAME }}`
            **ç‰ˆæœ¬ä»£ç **: `${{ env.VERSION_CODE }}`
            **æž„å»ºåˆ†æ”¯**: `dev`
            **æäº¤ SHA**: `${{ github.sha }}`
            **æž„å»ºæ—¶é—´**: `${{ env.BUILD_TIME }}`

            ---

            ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
            - è¿™æ˜¯**å¼€å‘æµ‹è¯•ç‰ˆæœ¬**ï¼Œå¯èƒ½åŒ…å«æœªå®Œæˆçš„åŠŸèƒ½æˆ– Bug
            - æ¯æ¬¡ dev åˆ†æ”¯æ›´æ–°æ—¶ï¼Œæ­¤ Release ä¼šè¢«**è‡ªåŠ¨è¦†ç›–**
            - å¦‚éœ€ç¨³å®šç‰ˆæœ¬ï¼Œè¯·è®¿é—® [æ­£å¼ç‰ˆ Release](../../releases/tag/main-latest)

            ### ðŸ”— å›ºå®šä¸‹è½½é“¾æŽ¥ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼Œç”¨äºŽäºŒç»´ç ï¼‰
            ```
            https://github.com/${{ github.repository }}/releases/download/dev-latest/droplink-dev.apk
            ```

            ### ðŸ“ æœ€è¿‘æäº¤
            ${{ github.event.head_commit.message }}
          files: output/droplink-dev.apk
          draft: false
          prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æž„å»ºä¿¡æ¯æ‘˜è¦
      - name: Build summary
        run: |
          echo "## ðŸš€ Dev æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ env.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬ä»£ç **: ${{ env.VERSION_CODE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ å›ºå®šä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/download/dev-latest/droplink-dev-${{ env.VERSION_NAME }}.apk" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
