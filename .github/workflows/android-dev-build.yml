name: Android Dev Build

on:
  # ç›‘å¬ dev åˆ†æ”¯çš„æŽ¨é€
  push:
    branches:
      - dev

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build:
    name: æž„å»º Dev ç‰ˆæœ¬
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # è®¾ç½® JDK 11 çŽ¯å¢ƒ
      - name: è®¾ç½® JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: gradle

      # æŽˆäºˆ gradlew æ‰§è¡Œæƒé™
      - name: æŽˆäºˆ Gradle æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      # ç¼“å­˜ Gradle ä¾èµ–
      - name: ç¼“å­˜ Gradle åŒ…
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # è®¡ç®—ç‰ˆæœ¬å·
      # æ ¼å¼ï¼š0.1.xï¼ˆx ä¸º GitHub run_numberï¼‰
      # ç¤ºä¾‹ï¼šç¬¬ 1 æ¬¡æž„å»º -> 0.1.1ï¼Œç¬¬ 50 æ¬¡æž„å»º -> 0.1.50
      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION_NAME="0.1.${{ github.run_number }}"
          VERSION_CODE=${{ github.run_number }}
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "ðŸ“¦ ç‰ˆæœ¬å·: $VERSION_NAME (versionCode: $VERSION_CODE)"

      # è¿è¡Œå•å…ƒæµ‹è¯•
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: ./gradlew test

      # æž„å»º Debug APKï¼ˆå¸¦ç‰ˆæœ¬å·ï¼‰
      - name: æž„å»º Debug APK
        run: ./gradlew assembleDebug
        env:
          VERSION_NAME: ${{ env.VERSION_NAME }}
          VERSION_CODE: ${{ env.VERSION_CODE }}

      # é‡å‘½å APK æ–‡ä»¶ï¼ˆåŒ…å«ç‰ˆæœ¬å·ï¼‰
      - name: é‡å‘½å APK
        run: |
          mkdir -p output
          cp app/build/outputs/apk/debug/app-debug.apk output/droplink-dev-${{ env.VERSION_NAME }}.apk
          echo "âœ… APK å·²é‡å‘½åä¸º: droplink-dev-${{ env.VERSION_NAME }}.apk"

      # ä¸Šä¼  APK åˆ° GitHub Artifacts
      - name: ä¸Šä¼  APK
        uses: actions/upload-artifact@v4
        with:
          name: droplink-dev-${{ env.VERSION_NAME }}
          path: output/droplink-dev-${{ env.VERSION_NAME }}.apk
          retention-days: 30

      # è¾“å‡ºæž„å»ºä¿¡æ¯
      - name: æž„å»ºä¿¡æ¯æ‘˜è¦
        run: |
          echo "## ðŸš€ Dev æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ env.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬ä»£ç **: ${{ env.VERSION_CODE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
