name: Android Dev Build

on:
  # ç›‘å¬ dev åˆ†æ”¯çš„æŽ¨é€
  push:
    branches:
      - dev

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build:
    name: æž„å»º Dev ç‰ˆæœ¬
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # è®¾ç½® JDK 17ï¼ˆå‚è€ƒ android-release.ymlï¼‰
      - name: Set up JDK
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      # éªŒè¯ Java çŽ¯å¢ƒ
      - name: Verify Java
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          java -version

      # æŽˆäºˆ gradlew æ‰§è¡Œæƒé™
      - name: Make gradlew executable
        run: chmod +x gradlew

      # è®¾ç½®ç‰ˆæœ¬å·ï¼ˆ0.1.x æ ¼å¼ï¼‰
      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION_NAME="0.1.${{ github.run_number }}"
          VERSION_CODE=${{ github.run_number }}
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "ðŸ“¦ ç‰ˆæœ¬å·: $VERSION_NAME (versionCode: $VERSION_CODE)"

      # è¿è¡Œå•å…ƒæµ‹è¯•
      - name: Run tests
        run: ./gradlew test

      # æž„å»º Debug APK
      - name: Build debug APK
        env:
          VERSION_NAME: ${{ env.VERSION_NAME }}
          VERSION_CODE: ${{ env.VERSION_CODE }}
        run: |
          echo "Using JAVA_HOME=$JAVA_HOME"
          ./gradlew assembleDebug --stacktrace

      # é‡å‘½å APK æ–‡ä»¶
      - name: Rename APK
        run: |
          mkdir -p output
          cp app/build/outputs/apk/debug/app-debug.apk output/droplink-dev-${{ env.VERSION_NAME }}.apk
          echo "âœ… APK å·²é‡å‘½åä¸º: droplink-dev-${{ env.VERSION_NAME }}.apk"

      # ä¸Šä¼  APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: droplink-dev-${{ env.VERSION_NAME }}
          path: output/droplink-dev-${{ env.VERSION_NAME }}.apk
          retention-days: 30

      # æž„å»ºä¿¡æ¯æ‘˜è¦
      - name: Build summary
        run: |
          echo "## ðŸš€ Dev æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ env.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬ä»£ç **: ${{ env.VERSION_CODE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
