name: Android Release

on:
  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    # åˆ›å»º tag æ—¶è§¦å‘ï¼ˆç”¨äºŽæ­£å¼å‘å¸ƒï¼‰
    tags:
      - 'v*'

  # PR æ£€æŸ¥
  pull_request:
    branches:
      - main

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æŽˆäºˆ GitHub Actions åˆ›å»º Release çš„æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º/æ›´æ–° Release å’Œ Tag

jobs:
  build:
    name: æž„å»º Release ç‰ˆæœ¬
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # è®¾ç½® JDK 17
      - name: Set up JDK
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      # éªŒè¯ Java çŽ¯å¢ƒ
      - name: Verify Java
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          java -version

      # æŽˆäºˆ gradlew æ‰§è¡Œæƒé™
      - name: Make gradlew executable
        run: chmod +x gradlew

      # è®¾ç½®ç‰ˆæœ¬å·ï¼ˆåŸºäºŽ Git æäº¤æ€»æ•°ï¼Œä¸Ž dev åˆ†æ”¯ä¿æŒä¸€è‡´ï¼‰
      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version
        run: |
          # ä½¿ç”¨ Git æäº¤æ€»æ•°ä½œä¸ºç‰ˆæœ¬å·åŸºå‡†ï¼ˆä¸Ž dev åˆ†æ”¯ä¸€è‡´ï¼‰
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION_NAME="0.1.${COMMIT_COUNT}"
          VERSION_CODE=${COMMIT_COUNT}
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "ðŸ“¦ Release ç‰ˆæœ¬å·: $VERSION_NAME (versionCode: $VERSION_CODE)"
          echo "ðŸ“Š åŸºäºŽ Git æäº¤æ€»æ•°: $COMMIT_COUNT"
          echo "ðŸ• æž„å»ºæ—¶é—´: $BUILD_TIME"

      # ç¼“å­˜ Gradle ä¾èµ–ï¼ˆåŠ é€Ÿæž„å»ºï¼‰
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # è¿è¡Œæµ‹è¯•
      - name: Run tests
        run: ./gradlew test --stacktrace

      # æž„å»º Release APK
      - name: Build release APK
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          VERSION_NAME: ${{ env.VERSION_NAME }}
          VERSION_CODE: ${{ env.VERSION_CODE }}
        run: |
          echo "Using JAVA_HOME=$JAVA_HOME"
          ./gradlew assembleRelease --stacktrace

      # é‡å‘½å APK æ–‡ä»¶
      - name: Rename APK
        run: |
          mkdir -p output
          cp app/build/outputs/apk/release/app-release.apk output/droplink-release-${{ env.VERSION_NAME }}.apk
          echo "âœ… APK å·²é‡å‘½åä¸º: droplink-release-${{ env.VERSION_NAME }}.apk"

      # ä¸Šä¼  APK åˆ° Artifacts
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: droplink-release-${{ env.VERSION_NAME }}
          path: output/droplink-release-${{ env.VERSION_NAME }}.apk
          retention-days: 90

      # è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Release (è¦†ç›–å¼å‘å¸ƒ main-latest)
      - name: Create or Update Main Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: main-latest
          name: "âœ… æ­£å¼ç‰ˆ (æœ€æ–°ç¨³å®šç‰ˆ)"
          body: |
            ## ðŸ“¦ Droplink æ­£å¼ç‰ˆ - ç¨³å®šå‘å¸ƒ

            **ç‰ˆæœ¬å·**: `${{ env.VERSION_NAME }}`
            **ç‰ˆæœ¬ä»£ç **: `${{ env.VERSION_CODE }}`
            **æž„å»ºåˆ†æ”¯**: `main`
            **æäº¤ SHA**: `${{ github.sha }}`
            **æž„å»ºæ—¶é—´**: `${{ env.BUILD_TIME }}`

            ---

            ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
            - è¿™æ˜¯**æ­£å¼ç¨³å®šç‰ˆæœ¬**ï¼Œå·²é€šè¿‡å®Œæ•´æµ‹è¯•
            - æ¯æ¬¡ main åˆ†æ”¯æ›´æ–°æ—¶ï¼Œæ­¤ Release ä¼šè¢«**è‡ªåŠ¨è¦†ç›–**
            - å¦‚éœ€æµ‹è¯•æœ€æ–°åŠŸèƒ½ï¼Œè¯·è®¿é—® [Dev å¼€å‘ç‰ˆ Release](../../releases/tag/dev-latest)

            ### ðŸ”— å›ºå®šä¸‹è½½é“¾æŽ¥ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰
            ```
            https://github.com/${{ github.repository }}/releases/download/main-latest/droplink-release-${{ env.VERSION_NAME }}.apk
            ```

            ### ðŸ“ æœ€è¿‘æäº¤
            ${{ github.event.head_commit.message }}
          files: output/droplink-release-${{ env.VERSION_NAME }}.apk
          draft: false
          prerelease: false  # æ ‡è®°ä¸ºæ­£å¼ç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # åˆ›å»ºç‰ˆæœ¬åŒ– Releaseï¼ˆä»…å½“æŽ¨é€ tag æ—¶ï¼Œå¦‚ v1.0.0ï¼‰
      - name: Create Versioned GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: output/droplink-release-${{ env.VERSION_NAME }}.apk
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æž„å»ºä¿¡æ¯æ‘˜è¦
      - name: Build summary
        if: success()
        run: |
          echo "## âœ… Release æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ env.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬ä»£ç **: ${{ env.VERSION_CODE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ å›ºå®šä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/download/main-latest/droplink-release-${{ env.VERSION_NAME }}.apk" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **å‘å¸ƒç‰ˆæœ¬æ ‡ç­¾**: ${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY
          fi
