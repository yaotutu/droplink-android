# 二维码登录功能测试指南

## 功能概述

二维码登录是 Droplink Android 应用的第三种登录方式，允许用户通过扫描服务器生成的二维码快速登录。

## 测试前准备

### 1. 生成测试二维码

使用以下 JSON 数据生成二维码（可使用在线二维码生成器，如 https://www.qr-code-generator.com/）：

```json
{
  "version": "1.0",
  "type": "droplink_qr_login",
  "timestamp": 1737547200000,
  "data": {
    "gotifyServerUrl": "http://111.228.1.24:2345",
    "appToken": "A1B2C3D4E5F6G7H8",
    "clientToken": "X9Y8Z7W6V5U4T3S2",
    "serverName": "测试服务器"
  }
}
```

**注意**：
- `timestamp` 字段需要更新为当前时间戳（毫秒），确保在 5 分钟有效期内
- 可以使用 JavaScript 获取当前时间戳：`Date.now()`
- 或使用在线工具：https://currentmillis.com/

### 2. 更新时间戳

在 Python 中生成当前时间戳：
```python
import time
import json

current_timestamp = int(time.time() * 1000)
qr_data = {
    "version": "1.0",
    "type": "droplink_qr_login",
    "timestamp": current_timestamp,
    "data": {
        "gotifyServerUrl": "http://111.228.1.24:2345",
        "appToken": "A1B2C3D4E5F6G7H8",
        "clientToken": "X9Y8Z7W6V5U4T3S2",
        "serverName": "测试服务器"
    }
}
print(json.dumps(qr_data, ensure_ascii=False))
```

## 测试步骤

### 测试 1：正常扫码登录流程

1. **启动应用**
   ```bash
   adb shell am start -n top.yaotutu.droplink/.MainActivity
   ```

2. **切换到二维码登录 Tab**
   - 在登录界面，点击"二维码登录" Tab
   - 应该看到说明卡片和"扫描二维码"按钮

3. **点击扫描按钮**
   - 点击"扫描二维码"按钮
   - 应该弹出相机权限请求对话框

4. **授予相机权限**
   - 点击"允许"授予相机权限
   - 相机预览应该立即显示
   - 应该看到扫描框覆盖层（半透明黑色背景 + 白色边框 + 绿色角标）

5. **扫描二维码**
   - 将二维码放入扫描框内
   - 应该自动识别并触发登录流程
   - 成功后应该跳转到主页面

**预期结果**：
- ✅ 相机预览正常显示
- ✅ 扫描框 UI 正确渲染
- ✅ 二维码识别成功
- ✅ 自动登录并跳转到主页

### 测试 2：拒绝相机权限

1. 点击"扫描二维码"按钮
2. 在权限对话框中点击"拒绝"

**预期结果**：
- ✅ 显示"需要相机权限才能扫描二维码"提示
- ✅ 显示"授予权限"和"取消"按钮
- ✅ 点击"授予权限"可以重新请求权限
- ✅ 点击"取消"返回登录表单

### 测试 3：停止扫描

1. 点击"扫描二维码"按钮并授予权限
2. 在相机预览界面，点击右上角的"X"按钮

**预期结果**：
- ✅ 相机预览关闭
- ✅ 返回到登录表单（显示"扫描二维码"按钮）

### 测试 4：扫描无效二维码

准备以下测试用例：

#### 4.1 普通 URL 二维码
生成包含普通 URL 的二维码（如 "https://www.google.com"）

**预期结果**：
- ✅ 显示错误提示："二维码格式错误，请扫描 Droplink 服务器生成的二维码"

#### 4.2 错误的 type 字段
```json
{
  "version": "1.0",
  "type": "other_app_qr_code",
  "timestamp": 1737547200000,
  "data": { ... }
}
```

**预期结果**：
- ✅ 显示错误提示："二维码类型不正确，请扫描 Droplink 服务器生成的二维码"

#### 4.3 过期的二维码
使用 6 分钟前的时间戳：
```json
{
  "version": "1.0",
  "type": "droplink_qr_login",
  "timestamp": 1737540000000,
  "data": { ... }
}
```

**预期结果**：
- ✅ 显示错误提示："二维码已过期，请重新生成"

#### 4.4 缺少必需字段
```json
{
  "version": "1.0",
  "type": "droplink_qr_login",
  "timestamp": 1737547200000,
  "data": {
    "gotifyServerUrl": "http://111.228.1.24:2345"
    // 缺少 appToken 和 clientToken
  }
}
```

**预期结果**：
- ✅ 显示错误提示："二维码数据不完整，请检查服务器配置"

### 测试 5：网络错误处理

1. 断开设备网络连接（关闭 WiFi 和移动数据）
2. 扫描有效的二维码

**预期结果**：
- ✅ 显示网络错误提示："无法连接到服务器，请检查网络连接"

### 测试 6：Token 验证失败

使用无效的 Token 生成二维码：
```json
{
  "version": "1.0",
  "type": "droplink_qr_login",
  "timestamp": 1737547200000,
  "data": {
    "gotifyServerUrl": "http://111.228.1.24:2345",
    "appToken": "INVALID_TOKEN",
    "clientToken": "INVALID_TOKEN",
    "serverName": "测试服务器"
  }
}
```

**预期结果**：
- ✅ 显示 Token 验证失败提示："Token 验证失败，请检查是否正确"

## 性能测试

### 1. 扫描响应时间
- 从二维码进入扫描框到识别成功，应该在 **1-2 秒**内完成

### 2. 相机启动时间
- 从点击"扫描二维码"到相机预览显示，应该在 **1 秒**内完成

### 3. 登录流程时间
- 从扫描成功到跳转主页，应该在 **2-3 秒**内完成（取决于网络速度）

## 日志监控

在测试过程中，可以使用以下命令监控日志：

```bash
# 监控二维码相关日志
adb logcat | grep -E "QrCode|Camera|MLKit"

# 监控登录相关日志
adb logcat | grep -E "Login|Auth"

# 监控所有应用日志
adb logcat | grep "droplink"
```

## 已知问题

1. **图标问题**：当前使用 `Icons.Default.Lock` 作为扫描按钮图标，语义不够准确
   - **建议**：后续可以添加自定义的相机或二维码图标

2. **扫描动画**：当前扫描框是静态的，没有扫描线动画
   - **建议**：可以添加一条从上到下移动的扫描线，提升用户体验

## 测试检查清单

- [ ] 正常扫码登录流程
- [ ] 相机权限请求和拒绝处理
- [ ] 停止扫描功能
- [ ] 扫描普通 URL 二维码（错误处理）
- [ ] 扫描错误 type 的二维码（错误处理）
- [ ] 扫描过期二维码（错误处理）
- [ ] 扫描缺少字段的二维码（错误处理）
- [ ] 网络错误处理
- [ ] Token 验证失败处理
- [ ] 扫描响应时间测试
- [ ] 相机启动时间测试
- [ ] 登录流程时间测试

## 测试环境

- **设备**：Pixel XL (Android 10)
- **应用版本**：Debug Build
- **构建时间**：2026-01-22

## 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 正常扫码登录 | ⚪ 待测试 | |
| 相机权限处理 | ⚪ 待测试 | |
| 停止扫描 | ⚪ 待测试 | |
| 无效二维码处理 | ⚪ 待测试 | |
| 网络错误处理 | ⚪ 待测试 | |
| Token 验证失败 | ⚪ 待测试 | |
| 性能测试 | ⚪ 待测试 | |

---

**测试完成后，请更新此文档并记录测试结果。**
